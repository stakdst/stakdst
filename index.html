<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>英単語テスト</title>
<style>
body { 
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; 
  padding: 20px; 
  background: #f5f5f5; 
  color:#111; 
}
.container { 
  max-width: 900px; 
  margin: 0 auto; 
  background: rgba(255,255,255,0.95); 
  padding:20px; 
  box-shadow:0 8px 24px rgba(0,0,0,0.15); 
  border-radius:12px; 
}
h1 { margin-top:0; text-align:center; }
.controls { 
  margin-bottom: 18px; 
  display:flex; 
  gap:10px; 
  flex-wrap:wrap; 
  align-items:center; 
  justify-content:center;
}
#startBtn { 
  font-size:1.2rem; 
  padding:10px 20px; 
  border-radius:8px; 
  background:#4dabf7; 
  color:#fff; 
  border:none; 
  cursor:pointer; 
  transition: transform 0.1s, background 0.3s;
}
/* #startBtn:hover { background:#339af0; transform: translateY(-2px); } */
#startBtn:active { transform: translateY(1px); }
.word {
  font-size: 2.2rem; 
  margin: 20px 0; 
  padding: 20px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  text-align: center;
}
.choices { display:flex; flex-direction:column; gap:12px; margin-bottom:12px; }
.choiceBtn { 
  padding:14px; font-size:1.1rem; cursor:pointer; border:none; 
  background:#f0f0f0; border-radius:10px; 
  transition: transform 0.1s, background 0.3s, box-shadow 0.3s; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align:left;
}
/* .choiceBtn:hover { background:#e0e0ff; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); } */
.choiceBtn:active { transform: translateY(1px); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
/* 選択後の濃い色 */
.correct { background:#4dabf7 !important; color:#fff; }
.wrong { background:#ff6b6b !important; color:#fff; }
/* タイマー */
.timer { 
  font-size:1.2rem; font-weight:bold; margin: 10px 0; display:inline-block; 
  background:#272727; color:#fff; padding:8px 16px; border-radius:20px; 
  box-shadow:0 4px 10px rgba(0,0,0,0.2); text-align:center; 
  font-family: 'Roboto Mono', 'Noto Mono', monospace;
  white-space: nowrap; min-width: 300px;
}
.hidden { display:none; }
/* 結果画面 */
#summary { text-align:center; font-family:sans-serif; }
#summary h2 { font-size:2rem; margin-bottom:15px; }
.summary-card {
  display:inline-block;
  padding:20px 30px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.15);
  min-width:300px;
}
.result-row { 
  display:flex; justify-content:center; margin:5px 0; font-size:1.2rem; 
}
.result-label { width:40%; text-align:right; padding-right:5px; }
.result-value { width:35%; text-align:right; margin-right:25%; }

/* モバイル対応 */
@media (max-width: 600px) {
  .choiceBtn { font-size: 1.3rem; padding:16px; }
  .word { font-size: 2.5rem; padding:24px; }
  .controls { flex-direction:column; align-items:center; }
  #startBtn { width:100%; text-align:center; }
}
</style>
</head>
<body>
<div class="container">
  <h1>英単語テスト</h1>
  <div class="controls" id="controls">
    <label>範囲: <input id="rangeStart" type="number" min="1" value="1" style="width:70px"> 〜 
      <input id="rangeEnd" type="number" min="1" value="100" style="width:70px"></label>
    <label>制限時間(秒):
      <input id="timeInput" type="number" min="1" value="200" style="width:70px">
    </label>
    <label>選択肢:
      <select id="choiceCountSelect">
        <option value="2">2 個</option>
        <option value="3">3 個</option>
        <option value="4" selected>4 個</option>
        <option value="5">5 個</option>
        <option value="6">6 個</option>
        <option value="7">7 個</option>
        <option value="8">8 個</option>
      </select>
    </label>
    <button id="startBtn">スタート</button>
  </div>

  <div id="quizArea" class="hidden">
    <div id="globalTimer" class="timer"></div>
    <div id="englishWord" class="word"></div>
    <div id="choices" class="choices"></div>
  </div>
  <div id="summary" class="hidden"></div>

  <audio id="correctSound" src="correct.mp3" preload="auto"></audio>
  <audio id="wrongSound" src="wrong.mp3" preload="auto"></audio>
</div>

<script>
const wordPairs = [
  {english:"follow", japanese:"に続く,に従う", dummy:['を認める', '積極的な', '神経細胞', '商人', '毒', '構造', '代表して', '効率がいい', '補助金', 'を許す', '莫大な', '版', 'まさる', '子孫', '最も重要な', '干ばつ', '達成する', '省く', '険しい', '列', '発音する', '自由主義の', '腫瘍', '激怒した', '植生', 'を避ける', '乗り出す', '機会', '思春期の', '最近の', '心からの', '悲しむ', 'かかりやすい', '偶然', '進む', 'を理解する', '冊', '好奇心の強い', '残り,休息', '手段', '利益', '自動運転', 'まゆをひそめる', '飲み物', '請求書,紙幣,法案', '誓う', 'を設立する', '反逆者', '移住する', '衛星', '選択の自由', 'を保持する', '慈善', '孤立している', '監督者', '発送', 'を育てる', '才能', '一時的な', '装置', 'を危険にさらす', '財産', '不意に', '喜ぶ', '後者の', '不安な', '主題,テーマ', '感謝している', 'に返答する', '水準', '胸に抱く', '宇宙', 'を受け入れる', '止める', '切望する', '軌道', 'と主張する', '合併する', '文明', '会議', '存在する', '妥当な,正当な', '予知する', '良心', 'ぼやかす', '聴衆,観客', '秘書', '意味,感覚', '不器用な', '主に', 'を非難する', '境界', '部下', 'ガン', '謎', 'ついに', '牧草地', '生理的な', '駆りたてる', '刑']},
  {english:"consider", japanese:"を考慮する", dummy:['ボーッと光る', 'を認める', '損失', '誓う', '操作する', '結果', 'しないように', '移民', '終点', 'を保護する', '避難する', 'およそ', 'かく', 'を夢中にさせる', '義務,関税', '災害', 'それゆえに', '引き締まった,きつい', '道,方法,点', '関係なく', '続く', '包括的な', '契約', 'はね返る', 'その上', 'のどが渇く', '検索する', '広大な', '医学の', '改正,修正', '関係がある', '距離', 'を可能にする', '積み重ね', '施行する', '落とす', 'と主張する', 'を除いて', '導く,繋がる', '検定', '利用する,開発する', '以内で', 'そらす', 'を予言する', '精神', '精力的な', '語法', '車輪', '暴露する', '蓄積する', '広まっている', '棒,極', '収穫', '比較的', '暗唱する', '明らかにする', '職業,占領', '休止', '感謝している', 'ままでいる', '貴族階級', '一致する', '強烈な', '受け入れる,含む', 'を救助する', 'を決意する', '大陸', '商業', '差し込む', 'を転換する', 'を禁じる', 'いかさまをする', 'を促す', 'を許可する', '咲く', 'を表す', 'を脅迫する', '与える', '市長', '下水', '残念な', '産出する,屈する', '(手)をたたく', 'に貢献する', '精神の', '永久', 'を制限する', '浅い', '神話', '安心させる', 'を縫う', '量', '規律,分野', '具現する', 'いたずらな', '止める', 'に反対する', 'を後悔する', '失礼な', '飼いならす']},
  {english:"increase", japanese:"を増やす", dummy:['動揺している', '集中する', '縮む,減る', '名誉', '潜在的な', '痛む', '紫外', '女性の', '評価する,感謝する', '誓う', 'を逮捕する', '識別する', 'をまねる', '小説', '最も重要な', '肩をすくめる', 'を投資する', 'の準備をする', '逆に', 'ボーッと光る', 'ほとんど', 'を罰する', '航海', '約束,予約', 'AをBだと思う', '異なる', '日課の仕事', '泥棒', '柔軟な', '世代', 'をする余裕がある', '有能な', '依頼人', '急激な', 'を計算する', 'を楽しませる', 'する傾向がある', '大騒ぎ', '恵み', '隠す', '話', '激しい', '関連のある', 'に強いる', '微生物', '泣く', 'ささいな', '前の', 'まとめる', '急速な', '最近の', '特徴', '代表して', '学部,能力', '金額,合計,要約', '都合がいい', '領域', '通路', '印', '直接,指し示す', '倫理(学)', 'おぼれ死ぬ', '慣れる', '元気,罰金,細かい', '観光', 'を超える', '神経細胞', '鮮やかな', '取ってくる', '差し込む', '理想的な', 'に似ている', '子供', '委員会', '必ずしも', '領土,なわ張り', 'を保証する', '多彩', '記述', '高価な', 'めまい', '名声', '険しい', 'を向上させる', 'わかりやすい', 'を投げる', '選択の自由', 'を励ます', '吸う', '請求書,紙幣,法案', '薄れる', '貪欲な', 'を経験する', '機能', '逃げる', '手続き', '駆りたてる', 'をうらやむ', '会議', '耳が不自由な']},
  {english:"expect", japanese:"を予期する", dummy:['長所', '霊長類', 'そらす', '火山', 'を困惑させる', '変動範囲,領域', '急上昇する', '時々', '責任', 'を伝える', '永久', 'を追求する', '土壌', '国', '逆説', '移住する', '細長い一片', 'ばかげた', '陪審員', 'を刺激する', 'の跡をたどる', '野生生物', 'を妨げる', '単調な', '小道,足跡', '拍手する', '思い込む,引き受ける', '軍隊', '話', '宝石', '毒', '外見,様子,出現', '富', '命令,秩序,順番', 'そよ風', '控える', '陽気な', 'を犠牲にする', '投票', '一晩', '流動的な', '4分の1', 'を推定する', '精神科医', 'の準備をする', 'に合う', '借金', '再開する', '憎しみ', '悲劇', '領域', '悲鳴をあげる', 'きっかけになる', 'の上に', 'に感染する', 'を計算する', '革新', '量', '強める', 'ちゃんとした', '辞める', '妥当な,正当な', '生態', 'を禁止する', '栄養', '規範', '首都,資本', '美辞麗句', 'を受け継ぐ', '疲れ切る', '女性の', 'なだめる', 'を見落とす', 'を理解する', '抑制する', '化学的な', '強烈な', '異なる', '高価な', '逆に', '証言する', 'を見分ける', '出来事', '本物の', '先行する', '疲労', '倫理(学)', '用心', '源', 'に抵抗する', 'を断る', '不快な', '自然に起こる', '情熱', '姿勢', '暴動', '惑星', '種,分類する', '乗組員たち', 'を解釈する']},
  {english:"relate", japanese:"関係がある", dummy:['強さ', '穴をあける', '孤立している', '起業家', '本来の', '破る,違反する', 'さまざまな', 'を促進する', '公共事業', 'すなわち', '従う', 'を無視する,を解雇する', '浸る', '一貫した', 'に訴える,を引きつける', '選択の自由', '論理', 'だが一方', '比率', '細部', '口論', 'を評価する', '地平線', '先行する', 'を非難する,のせいにする', '省く', '乗り物,手段', '識別する', '領域,範囲', '兵器', '循環', '商人', '優先', '対立', 'を購入する', '利用する,開発する', '苦しみ,苦難', '類似の', '流動的な', '子孫', '重要な', '純', '剣', '霊長類', 'かきたてる', '主要な', '意味,感覚', '秘けつ', '言い訳', '見通し', 'を供給する', 'かすかな', '積極的な', '遺産', '適切な', '交流', '法廷,中庭', '憎しみ', 'すばらしい', '無謀な', '定義する', '構造', 'ほとんどない', '内気な', '郊外', '阻害する', 'そらす', '方法', '幼児', '流体', '新人採用', 'しばしば', 'ちらり', '楽しい', '現在,与える', '消化する', '証明書', '主要な', 'ついに', 'を欲求不満にさせる', '肉', '次に起こる', '志向', 'を送る,伝える', 'すらりとした', '無限の', '突く', 'ひどい', 'を卒業する', '焦点を合わせる', '反応する', '不足', '回転する', '無傷の', '静的な', 'を選挙で選ぶ', '雑用', '取り出す', '光景', '告白する']},
  {english:"compare", japanese:"を比べる", dummy:['肩をすくめる', '固く守る', 'さび', 'かかりやすい', '複雑な', '一時的な', '赤道', '衛生', 'をいらいらさせる', 'を指し示す', 'を送る,伝える', '認める', '中心,核心', 'を認める,を与える', '部分,区分', '糸', 'に打ち勝つ', '緊張', '緊急の', 'びっくりさせる', '牧草地', 'とばす,抜かす', '国', '首都,資本', 'を繁殖させる', '乗り物,手段', '量', '強制する', '表面的な', 'さまざまな', '道', '熱望', '洗練する', 'を取り除く', 'を経験する', 'を楽しませる', '冷静な', '犯罪', '動機', '章', '放出する', 'を楽しませる', '欠乏', 'すべきである', '4分の1', '生産高', '弱める', '(問題)深刻な,(痛み)鋭い', '合図', 'ほとんどない', 'を解放する,を発表する', 'を投げる', 'を予期する', '汗', 'について述べる', '所属している', '効率がいい', '引きずる', '外交の', '(手)をたたく', 'を修正する', '避難する', 'を困らせる', 'こぶ', '教授', 'を縫う', '言葉による', '寒気', '崇拝する', '報酬', '虐待', '傑作', '生き返らせる', '都合がいい', '結果', 'を考慮する', '政治的な', '伝説', '土壌', 'を征服する', '拷問', 'とってかわる', '続く,最近', 'すばらしい', '脳卒中,打撃', '激怒,怒り', 'から回復する', '話', '化石', '動物', '理想的な', '人類', 'を思い出す', '最新の', '湿った', '賭け金', 'を断る', '類似の', '遺産', '花']},
  {english:"spread", japanese:"を広げる", dummy:['邪悪な', '富', '当然だ', '誘う', 'つかむ', '戦略', '遅れ', '改革', '宗教', '店,蓄える', '繁栄する', '数字,図形,人物の像', '欠点', '重大な', 'を非難する', '議会', '徹底的に', '物質', 'わざと', 'なだめる', '慈悲,情け', '散文', '状態,述べる,国家', '耐える,産む,熊', 'を向上させる', '指定する', '再開する', '中身,いっぱいの', 'したがらない', 'はげます', 'と主張する', '放射線', '腐敗', '臨床', 'を失望させる', 'を当惑させる', 'の上に', '典型的な', 'ガン', '裸の', '活動家', '宣言する', '祈る', '前途有望な', 'だから', '荷物', '塾', '水準', '入学する', '必ずしも', '領域', 'をからかう', '潜在的な', 'を選ぶ', '腫瘍', '脳卒中,打撃', 'を無視する,怠る', '地区', '借金', '殺人', 'めちゃくちゃ', '設備,施設', '報道', '相互の', 'ぼっ発', '地位', '契約', '仕事', '豊富な', '陪審員', 'の価値がある', '隠す', '分類する', '指摘する,意味,主張,点', '終点', 'いたずら', 'を設立する', '孵化する', '資源', '難民', '器具', '検査する', '正確な', 'しがちである', 'こぶ', 'を考慮する', 'ばか', '実験', 'メールを送る', 'まともな', '逃げる', '粉々に砕く', 'と結論づける', '合法の,法律の', '安全', '公共事業', '同時に起きる,重なる', '特徴', '労働', 'を結合させる']},
  {english:"refer", japanese:"を指示する", dummy:['壁', '最高の', '不器用な', '物体,反対する', 'クラシックの', '定義する', 'を判断する', '想像する', '理にかなった', '無数の', '建築', '現象', '所得', '散文', '気楽な', '明らかな', '信頼', '縛る,束縛する', 'コラム', '権威,権力', 'からかう', '理性的な', '宗教', '潜在的な', '例', 'よさりかかる', 'すなわち', '欠乏', '謎', 'びっくりさせる', '植民地', '主張する', 'を達成する', '干ばつ', 'にエサをやる', '証人,目撃者', 'プロフィール', 'のどが渇く', '時代', '勤勉な', '背景,経歴', '親密な', 'を結合させる', '浸す', 'に知らせる', '肺', '特徴', '用意ができた', '気温', '直感', '積極的な', 'に到着する', 'うたた寝', '石油', '意識している', '無知な', '距離', '断言する', '小説', '呼吸の', 'を犠牲にする', '味,好み', '刑務所', '循環', '恐怖', '語彙', '手がかり', '大災害', '地震', '幼児', '言葉による', 'だから', '敵', '憲法', 'を非難する', '正確な', '衛生', '政治家', '討論', '移住する', '量', '荒野', 'を励ます', '熱望している', '印象', '契約', '維持する,主張する', 'を捜す', 'を共有する', '財政的な', '証明書', '生物', '緊急事態', 'よりすぐれている', '暴動', '一般', '規範', '耐える,産む,熊', '宝くじ', '主要な']},
  {english:"approve", japanese:"賛成する", dummy:['処刑する', '顕著な', '悪夢', 'すばやい', 'を生み出す', '懐疑的な', 'を代わりに用いる', '奴隷', '商品', '教育課程', 'を設立する', '愛情', 'を見落とす', '儀式', '部族', '電気', '口述の', '衝突', '災いのもと', '凍りつく', '普及している', 'を所有している', 'ばかな', '逃げる', '都合がいい', '残酷な', 'を驚嘆させる', 'を引っぱる', '養う', '野獣', '相続人', '正確な', '遺伝', '同等のもの', 'を誤解する', '循環', '繊細な', '個人', '掘り出し物', '偏見', 'を設立する', '大使', 'を供給する', '正気じゃない', '肥満', '細胞', '理にかなった', 'に適している', '対話', '物体,反対する', '前の', 'を比べる', '適切な', '形', 'を制限する', '新陳代謝', '家具', '壊れやすい', '誓う', 'いじめ', '落とす', '大臣', '危機', '見知らぬ人', '移民', '感謝している', 'ポキッと折れる', '共産主義の', 'とてつもない', '棚', 'をする余裕がある', '料理', 'に知らせる', '移住する', '群衆', '前任者', 'を当惑させる', '中止する,つるす', '疲労', '貴重な', 'かかりやすい', '階級制度', '急上昇する', '必要な,生き生きとした', '依頼人', '異なる', '罠,捕える', 'をおびえさせる', '(手)をたたく', 'を困らせる', '物質', '親戚', '説教する', '安心させる', '試み,裁判', '一般市民の', 'に打ち勝つ', '楽観的な', '複雑な', '部門']},
  {english:"weigh", japanese:"の重さがある,よく考える", dummy:['贅沢', '予知する', 'ふける', '先', '恐れる', 'ほとんど', 'きずな', '州', '基本的な', '推定する,思う', '見方', 'に返答する', 'をおびえさせる', 'を選挙で選ぶ', 'すばらしい', '側面', '印', '移り変わり', '成熟した', 'にさらす', '受け入れる,含む', '衝動', '放射線', 'いかさまをする', '怒らせる', '神聖なる', '材料', '孤立している', '明らかな', '用心', '発症', '貧乏', '野蛮な', '探査機', 'したがらない', '忍び寄る', 'を組み立てる', '商人', '材木', '加速する', 'を許す', 'を必要とする', '可能性', '装置', '辞める', 'を操作する,手術する', '取り入れる', '部分', 'を含んでいる', 'Aが好きだ', '孵化する', '一般', '祝福する', '指摘する,意味,主張,点', '一貫した', '有能な', '貨物', 'めったにない', 'を装飾する', '市民', 'ため息をつく', 'を借りる', '収入', '育てる', '似ている', 'にもかかわらず', '手段', 'を認める', '種', '薄れる', '探検', '依頼人', 'を驚嘆させる', '根本的な', '否定する', 'を広げる', '陽気な', '試み,裁判', '日課の仕事', '誘惑する,する気にさせる', '倫理(学)', '逆に', '洪水', '利己的な', 'にエサをやる', '空白', 'ばかな', 'すばやい', '感謝している', 'を評価する', '恥ずかしい', '珍しい', '予算', '量', '補う', '嘆く', '時間を守る', 'を取り囲む', '見知らぬ人', '結果']},
  {english:"stretch", japanese:"を広げる", dummy:['場面', 'すなわち', '厳しい', '会社,堅い', '両腕,軍備', '災いのもと', '欠乏', '粒子', '壊滅させる', '言葉による', 'を団結させる', '物質', '受けやすい', '大災害', '織物,布', '本部,本社', 'しがちである', '知恵', '独立した', 'つまずく', '永久', 'ばか', '見通し', 'を翻訳する', 'を認める,を与える', '野獣', '交通機関,輸送', 'それ相応に', '必死の', '生き返らせる', '運命', '感覚,感じ', '個人', 'に頼る', '疫病', '重荷', '細胞', '身をかがめる', '連れ合い', 'を生産する', '究極の', '甥', 'イデオロギー', '摂取量', 'を探検する', '小道', 'から生じる,に由来する', '宴会', '帝国', 'を強制する', 'ちゃんとした', '燃料', '記念日', '泣く', 'を許す', '従う', '話', 'を認める', 'ほとんどない', '祖先', '爆弾', '刺激する', '電気', '逆説', 'おしゃべりする', '元から伴う', '式,方法', '修正する', 'そらす', 'はげます', '高さ,最盛期', 'つもりだ', '中立の', '意味,感覚', '取り出す', '企業', 'を発見する', '上級の,先輩の', 'すばらしい', '実行する', '教育課程', '法律', '一般', '装置', '同僚', '渋滞', 'を変える', '環境保護', 'を守る', '行う,行動', '圧倒的な', '心からの', 'ひどい', '水分', '二言語使用の', '組み立てる', '桁', '生物', 'を見落とす', '落とす']},
// ADD WORDS
];

let quizList=[], currentIndex=0, correctCount=0, incorrectCount=0, globalTime=0, startTime=0, animationFrameId=null, canSelect=true, totalQuestions=0;

const startBtn=document.getElementById('startBtn');
const rangeStart=document.getElementById('rangeStart');
const rangeEnd=document.getElementById('rangeEnd');
const timeInput=document.getElementById('timeInput');
const choiceCountSelect=document.getElementById('choiceCountSelect');
const quizArea=document.getElementById('quizArea');
const englishWordDiv=document.getElementById('englishWord');
const choicesDiv=document.getElementById('choices');
const summaryDiv=document.getElementById('summary');
const globalTimerDiv=document.getElementById('globalTimer');
const controls=document.getElementById('controls');

rangeStart.addEventListener('input',updateTimeByRange);
rangeEnd.addEventListener('input',updateTimeByRange);
function updateTimeByRange(){
  const start=parseInt(rangeStart.value)||1;
  const end=parseInt(rangeEnd.value)||wordPairs.length;
  if(start<1||end<start) return;
  const count=end-start+1;
  timeInput.value=Math.ceil(count*2);
}

startBtn.addEventListener('click',()=>{
  const start=parseInt(rangeStart.value)||1;
  const end=parseInt(rangeEnd.value)||wordPairs.length;
  if(start<1||end>wordPairs.length||start>end){ alert("範囲指定が不正です"); return; }
  quizList=wordPairs.slice(start-1,end);
  quizList.sort(()=>Math.random()-0.5);
  totalQuestions=quizList.length;
  correctCount=0; incorrectCount=0; currentIndex=0; canSelect=true;

  quizArea.classList.remove('hidden'); summaryDiv.classList.add('hidden');
  Array.from(controls.querySelectorAll("input,select,button")).forEach(el=>el.disabled=true);

  globalTime=parseFloat(timeInput.value);
  startTime=performance.now();
  requestAnimationFrame(updateTimer);
  showQuestion();
  
  const correctSound = document.getElementById("correctSound");
  const wrongSound = document.getElementById("wrongSound");

  correctSound.playbackRate = 2.0;
  wrongSound.playbackRate = 1.5;

  [correctSound, wrongSound].forEach(snd=>{
    snd.volume = 0;
    snd.play().then(()=>{
      snd.pause();
      snd.currentTime = 0;
      snd.volume = 1;
    }).catch(e=>console.log("unlock error:", e));
  });
});

function updateTimer(timestamp){
  const elapsed=(timestamp-startTime)/1000;
  const remain=Math.max(globalTime-elapsed,0);
  globalTimerDiv.textContent=`正解数: ${correctCount}/${totalQuestions}問       時間: ${remain.toFixed(2)}`;
  if(remain<=0){ showSummary(false,true); }
  else{ animationFrameId=requestAnimationFrame(updateTimer); }
}

function showQuestion(){
  if(currentIndex>=quizList.length){ return showSummary(true,false); }
  canSelect=true;
  const item=quizList[currentIndex];
  englishWordDiv.textContent=item.english;
  globalTimerDiv.textContent=`正解数: ${correctCount}/${totalQuestions}問       時間: ${getRemainingTime().toFixed(2)}`;

  let choices=[item.japanese];
  const totalChoices=parseInt(choiceCountSelect.value);
  let dummies=[...item.dummy]; dummies.sort(()=>Math.random()-0.5);
  while(choices.length<totalChoices && dummies.length>0){ choices.push(dummies.pop()); }
  choices.sort(()=>Math.random()-0.5);

  choicesDiv.innerHTML="";
  choices.forEach(ch=>{
    const btn=document.createElement('button');
    btn.className="choiceBtn";
    btn.textContent=ch;
    btn.addEventListener('mousedown',()=>selectChoice(btn,ch,item.japanese));
    btn.addEventListener('touchstart',(e)=>{e.preventDefault(); selectChoice(btn,ch,item.japanese);},{passive:false});
    choicesDiv.appendChild(btn);
  });
}

function getRemainingTime(){ return Math.max(globalTime-(performance.now()-startTime)/1000,0); }

function selectChoice(btn, selected, correct){
  if(!canSelect) return;
  canSelect = false;

  const buttons = document.querySelectorAll(".choiceBtn");
  buttons.forEach(b => b.disabled = true);

  const correctSound = document.getElementById("correctSound");
  const wrongSound = document.getElementById("wrongSound");

  if(selected === correct){
    btn.classList.add("correct");
    correctCount++;
    correctSound.currentTime = 0;
    correctSound.play();

    // 0.5秒で次へ
    setTimeout(() => { 
      currentIndex++; 
      showQuestion(); 
    }, 500);

  } else {
    buttons.forEach(b => { 
      if(b.textContent === correct) b.classList.add("wrong"); 
    });
    quizList.push(quizList[currentIndex]);
    incorrectCount++;
    wrongSound.currentTime = 0;
    wrongSound.play();

    setTimeout(() => { 
      currentIndex++; 
      showQuestion(); 
    }, 800);
  }
}

function showSummary(cleared=false,timeOut=false){
  if(animationFrameId) cancelAnimationFrame(animationFrameId);
  quizArea.classList.add('hidden'); summaryDiv.classList.remove('hidden');
  Array.from(controls.querySelectorAll("input,select,button")).forEach(el=>el.disabled=false);

  let remainingQuestions = totalQuestions - correctCount; 

  let cardHTML='';
  if(timeOut){
    cardHTML=`<div class="summary-card">
      <h2>GameOver !</h2>
      <div class="result-row"><span class="result-label">正解数</span><span class="result-value">${correctCount}/${totalQuestions}問</span></div>
      <div class="result-row"><span class="result-label">miss</span><span class="result-value">${incorrectCount}回</span></div>
      <div class="result-row"><span class="result-label">あと</span><span class="result-value">${remainingQuestions}問</span></div>
    </div>`;
  }else{
    const elapsedTime=((performance.now()-startTime)/1000).toFixed(2);
    cardHTML=`<div class="summary-card">
      <h2>CLEAR!</h2>
      <div class="result-row"><span class="result-label">正解数</span><span class="result-value">${correctCount}/${totalQuestions}問</span></div>
      <div class="result-row"><span class="result-label">miss</span><span class="result-value">${incorrectCount}回</span></div>
      <div class="result-row"><span class="result-label">time</span><span class="result-value">${elapsedTime}秒</span></div>
    </div>`;
  }
  summaryDiv.innerHTML=cardHTML;
}
</script>
</body>
</html>
